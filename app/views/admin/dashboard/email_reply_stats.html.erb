<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <h2>Email Reply Analytics</h2>
      <p class="text-muted">Statistics for email responses to questions</p>

      <!-- Time period selector -->
      <div class="mb-3">
        <div class="btn-group" role="group">
          <%= link_to "Day", admin_email_reply_stats_path(period: 'day'), class: "btn btn-#{@time_period == 'day' ? 'primary' : 'outline-primary'}" %>
          <%= link_to "Week", admin_email_reply_stats_path(period: 'week'), class: "btn btn-#{@time_period == 'week' ? 'primary' : 'outline-primary'}" %>
          <%= link_to "Month", admin_email_reply_stats_path(period: 'month'), class: "btn btn-#{@time_period == 'month' ? 'primary' : 'outline-primary'}" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary stats -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <h5 class="card-title">Total Replies</h5>
          <h2 class="display-4"><%= @total_replies %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <h5 class="card-title">Success Rate</h5>
          <h2 class="display-4"><%= @success_rate %>%</h2>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Identification Methods</h5>
          <div class="progress" style="height: 30px;">
            <%
              # Define colors for each method
              colors = {
                'signed_reply_to' => 'bg-success',
                'headers' => 'bg-info',
                'subject_parsing' => 'bg-warning',
                'failed' => 'bg-danger',
                'unknown' => 'bg-secondary'
              }

              total = @identification_methods.values.sum
              total = 1 if total == 0 # Prevent division by zero
            %>

            <% @identification_methods.each do |method, count| %>
              <%
                percent = (count.to_f / total * 100).round(1)
                color = colors[method] || 'bg-secondary'
              %>
              <div class="progress-bar <%= color %>" role="progressbar" style="width: <%= percent %>%;"
                   title="<%= method %>: <%= count %> (<%= percent %>%)" aria-valuenow="<%= percent %>" aria-valuemin="0" aria-valuemax="100">
                <%= method %> (<%= percent %>%)
              </div>
            <% end %>
          </div>
          <div class="mt-3">
            <% @identification_methods.each do |method, count| %>
              <div class="badge <%= colors[method] || 'bg-secondary' %> p-2 me-2">
                <%= method %>: <%= count %> (<%= (count.to_f / total * 100).round(1) %>%)
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error breakdown -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Error Breakdown</h5>
        </div>
        <div class="card-body">
          <% if @error_types.any? %>
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Error Type</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody>
                <% @error_types.each do |error_type, count| %>
                  <tr>
                    <td><%= error_type.gsub('_', ' ').capitalize %></td>
                    <td><%= count %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <p class="text-muted">No errors recorded in this time period.</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Daily Trend</h5>
        </div>
        <div class="card-body">
          <canvas id="dailyTrend" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Get the canvas element
  var ctx = document.getElementById('dailyTrend').getContext('2d');

  // Prepare data for the chart
  var dailyData = <%= raw @daily_stats.to_json %>;
  var dates = [...new Set(Object.keys(dailyData).map(key => key[0]))].sort();

  // Get unique identification methods
  var methods = [...new Set(Object.keys(dailyData).map(key => key[1]))];

  // Define colors for each method
  var colorMap = {
    'signed_reply_to': 'rgba(40, 167, 69, 0.7)',
    'headers': 'rgba(23, 162, 184, 0.7)',
    'subject_parsing': 'rgba(255, 193, 7, 0.7)',
    'failed': 'rgba(220, 53, 69, 0.7)',
    'unknown': 'rgba(108, 117, 125, 0.7)'
  };

  // Prepare datasets
  var datasets = methods.map(method => {
    var data = dates.map(date => {
      var key = [date, method];
      return dailyData[key] || 0;
    });

    return {
      label: method,
      data: data,
      backgroundColor: colorMap[method] || 'rgba(108, 117, 125, 0.7)',
      borderColor: colorMap[method]?.replace('0.7', '1') || 'rgba(108, 117, 125, 1)',
      borderWidth: 1
    };
  });

  // Create the chart
  var myChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dates,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          stacked: true,
          title: {
            display: true,
            text: 'Date'
          }
        },
        y: {
          stacked: true,
          beginAtZero: true,
          title: {
            display: true,
            text: 'Reply Count'
          }
        }
      },
      plugins: {
        legend: {
          position: 'top',
        },
        title: {
          display: true,
          text: 'Email Replies by Identification Method'
        }
      }
    }
  });
});
</script>